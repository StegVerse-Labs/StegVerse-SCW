name: Autopatch StegVerse repos

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  autopatch:
    runs-on: ubuntu-latest

    env:
      # Fine-grained PAT with access to all target repos
      GH_TOKEN: ${{ secrets.PAT_WORKFLOW }}

    steps:
      - name: Checkout StegVerse-SCW
        uses: actions/checkout@v4

      - name: Install GitHub CLI (if needed)
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg |
              sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" |
              sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update -y
            sudo apt-get install -y gh
          else
            echo "GitHub CLI already installed."
          fi

      - name: Run autopatch across StegVerse repos
        run: |
          set -euo pipefail

          echo "=== StegVerse Autopatch ==="

          mkdir -p work

          echo "Cloning TVC (source of truth)..."
          # ðŸ”´ SINGLE authoritative clone â€” no second folder
          gh repo clone StegVerse-Labs/TVC work/TVC

          TEMPLATE_DIR="work/TVC/data"
          TV_CONFIG="${TEMPLATE_DIR}/tv_config.json"
          STEGTVC_CONFIG="${TEMPLATE_DIR}/stegtvc_config.json"

          echo "Verifying template files exist..."
          if [[ ! -f "${TV_CONFIG}" ]]; then
            echo "âŒ Missing template: ${TV_CONFIG}"
            exit 1
          fi
          if [[ ! -f "${STEGTVC_CONFIG}" ]]; then
            echo "âŒ Missing template: ${STEGTVC_CONFIG}"
            exit 1
          fi

          echo "Template files found:"
          ls -l "${TEMPLATE_DIR}"

          # ðŸ“ Repos to patch â€“ adjust this list as needed
          TARGET_REPOS=(
            "StegVerse-Labs/TVC"
            "StegVerse/TV"
            "StegVerse/hybrid-collab-bridge"
          )

          for REPO in "${TARGET_REPOS[@]}"; do
            echo ""
            echo "=== Patching ${REPO} ==="

            SAFE_NAME="${REPO//\//_}"          # e.g. StegVerse-Labs_TVC
            CLONE_DIR="work/${SAFE_NAME}"

            echo "Cloning ${REPO} into ${CLONE_DIR}..."
            gh repo clone "${REPO}" "${CLONE_DIR}"

            mkdir -p "${CLONE_DIR}/data"

            echo "Copying StegTVC config into ${REPO}..."
            cp "${TV_CONFIG}" "${CLONE_DIR}/data/tv_config.json"
            cp "${STEGTVC_CONFIG}" "${CLONE_DIR}/data/stegtvc_config.json"

            cd "${CLONE_DIR}"

            if git status --porcelain | grep -q .; then
              echo "Changes detected â€“ committing..."
              git config user.name "StegVerse-Autopatch"
              git config user.email "autopatch@stegverse.local"
              git add data/tv_config.json data/stegtvc_config.json
              git commit -m "Autopatch: sync StegTVC config"
              git push origin HEAD
            else
              echo "No changes to commit for ${REPO}."
            fi

            cd - >/dev/null
          done

          echo ""
          echo "âœ… Autopatch run completed."
